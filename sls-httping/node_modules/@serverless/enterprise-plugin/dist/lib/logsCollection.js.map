{"version":3,"sources":["../../src/lib/logsCollection.js"],"names":["ctx","sls","service","custom","enterprise","collectLambdaLogs","cli","log","template","provider","compiledCloudFormationTemplate","logGroups","length","tenant","accessKey","request","Account","destinationOpts","appUid","tenantUid","serviceName","getServiceName","stageName","getStage","regionName","getRegion","accountId","destinationArn","message","includes","Error","logGroupIndex","logGroupKey","key","logGroupName","resource","Properties","LogGroupName","filterPattern","startsWith","API_GATEWAY_FILTER_PATTERN","LAMBDA_FILTER_PATTERN","Resources","Type","DestinationArn","FilterPattern","Ref"],"mappings":"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","sourcesContent":["/*\n * Logs Collection\n * - Collects `SERVERLESS PLATFORM || REPORT` from lambda logs\n * - Collects `sls-access-logs` from API Gateway access logs\n */\n\nimport {\n  pickResourceType,\n  upperFirst,\n  API_GATEWAY_FILTER_PATTERN,\n  LAMBDA_FILTER_PATTERN\n} from './utils'\n\nimport { getAccessKeyForTenant, getLogDestination } from '@serverless/platform-sdk'\n\nexport default async (ctx) => {\n  if (\n    ctx.sls.service.custom &&\n    ctx.sls.service.custom.enterprise &&\n    ctx.sls.service.custom.enterprise.collectLambdaLogs === false\n  ) {\n    ctx.sls.cli.log(\n      'Info: This plugin is not configured to collect AWS Lambda Logs.',\n      'Serverless Enterprise'\n    )\n    return\n  }\n\n  const template = ctx.sls.service.provider.compiledCloudFormationTemplate\n\n  // Gather possible targets\n  const logGroups = pickResourceType(template, 'AWS::Logs::LogGroup')\n  if (logGroups.length === 0) {\n    return\n  }\n\n  const accessKey = await getAccessKeyForTenant(ctx.sls.service.tenant)\n  const { Account } = await ctx.provider.request('STS', 'getCallerIdentity', {})\n  const destinationOpts = {\n    accessKey,\n    appUid: ctx.sls.service.appUid,\n    tenantUid: ctx.sls.service.tenantUid,\n    serviceName: ctx.sls.service.getServiceName(),\n    stageName: ctx.provider.getStage(),\n    regionName: ctx.provider.getRegion(),\n    accountId: Account\n  }\n\n  let destinationArn\n\n  try {\n    ;({ destinationArn } = await getLogDestination(destinationOpts))\n  } catch (e) {\n    if (e.message && e.message.includes('not supported in region')) {\n      ctx.sls.cli.log(\n        `Warning: Lambda log collection is not supported in ${ctx.provider.getRegion()}`\n      )\n      return\n    }\n    throw new Error(e.message)\n  }\n\n  // For each log group, set up subscription\n  for (const logGroupIndex in logGroups) {\n    const logGroupKey = logGroups[logGroupIndex].key\n    const logGroupName = logGroups[logGroupIndex].resource.Properties.LogGroupName\n\n    const filterPattern = logGroupName.startsWith('/aws/api-gateway/')\n      ? API_GATEWAY_FILTER_PATTERN\n      : LAMBDA_FILTER_PATTERN\n\n    template.Resources[`CloudWatchLogsSubscriptionFilter${upperFirst(logGroupKey)}`] = {\n      Type: 'AWS::Logs::SubscriptionFilter',\n      Properties: {\n        DestinationArn: destinationArn,\n        FilterPattern: filterPattern,\n        LogGroupName: {\n          Ref: logGroupKey\n        }\n      }\n    }\n  }\n}\n"],"file":"logsCollection.js"}